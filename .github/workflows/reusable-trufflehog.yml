name: Reusable TruffleHog Secret Scan

on:
  workflow_call:
    inputs:
      fail-on-unverified:
        description: "Fail workflow on unverified secrets"
        required: false
        default: "false"
        type: string
      fail-on-verified:
        description: "Fail workflow on verified secrets"
        required: false
        default: "true"
        type: string
      scan-type:
        description: "Scan type: commits, filesystem, or both"
        required: false
        default: "both"
        type: string
      scan-scope:
        description: "Scan scope: changed-files, full-repo, or both"
        required: false
        default: "full-repo"
        type: string
      trufflehog-version:
        description: "TruffleHog version to use (optional override)"
        required: false
        default: ""
        type: string
      verify-secrets:
        description: "Enable secret verification against real APIs (may trigger rate limits)"
        required: false
        default: "true"
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  TRUFFLEHOG_VERSION: "3.75.0" # ratchet:trufflesecurity/trufflehog@v3.75.0

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          # Limited history to reduce credential exposure risk
          # 100 commits covers most recent development for security scanning
          fetch-depth: 100
          persist-credentials: false

      - name: Set TruffleHog version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.trufflehog-version }}
          DEFAULT_VERSION: ${{ env.TRUFFLEHOG_VERSION }}
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            echo "version=${INPUT_VERSION}" >> "${GITHUB_OUTPUT}"
          else
            echo "version=v${DEFAULT_VERSION}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin "${{ steps.version.outputs.version }}"
          trufflehog --version

      - name: Check test files for debugging
        run: |
          echo "=== Debugging: Check if test file exists ==="
          ls -la test-secrets.txt || echo "test-secrets.txt not found"
          echo "=== File content sample ==="
          head -10 test-secrets.txt || echo "Cannot read test-secrets.txt"

      - name: Identify changed files in pull request for targeted scanning
        id: changed-files
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          git diff --name-only "${BASE_SHA}..${HEAD_SHA}" > changed-files.txt
          echo "Changed files in this PR:"
          cat changed-files.txt || echo "No files changed"

      - name: Scan for secrets using TruffleHog (git history, filesystem, changed files)
        id: scan
        env:
          SCAN_TYPE: ${{ inputs.scan-type }}
          SCAN_SCOPE: ${{ inputs.scan-scope }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set +e

          # Initialize result files
          echo "[]" > all-results.json

          # TruffleHog optimizations applied:
          # --results=verified,unverified (include both verified and custom detector results)
          # --filter-unverified (only first unverified per chunk to reduce duplicates)
          # --filter-entropy=3.0 (filter low-entropy noise)
          # --max-depth=10 (limit git history)
          # --exclude-globs (skip common noise files)
          echo "TruffleHog optimized scan starting (includes custom detector results)..."

          # Full repository scanning
          if [[ "${SCAN_SCOPE}" == "full-repo" || "${SCAN_SCOPE}" == "both" ]]; then
            echo "Running full repository scan..."

            if [[ "${SCAN_TYPE}" == "commits" || "${SCAN_TYPE}" == "both" ]]; then
              echo "Scanning git commit history..."
              echo "=== TruffleHog command ==="
              echo "trufflehog git file://. --json --no-update (built-in detectors only)"

              # Scan with built-in detectors only
              echo "=== Scanning with built-in detectors ==="
              trufflehog git file://. \
                --json \
                --no-update \
                --results=verified,unverified \
                --filter-unverified \
                --filter-entropy=3.0 \
                --max-depth=10 \
                --exclude-globs="*.lock,*.sum,node_modules/**,*.git/**" \
                > commit-results.json || true

              echo "=== Raw results ==="
              head -20 commit-results.json || echo "No results file"
              echo "=== Results file size ==="
              wc -l commit-results.json || echo "No results file"
            fi

            if [[ "${SCAN_TYPE}" == "filesystem" || "${SCAN_TYPE}" == "both" ]]; then
              echo "Scanning current filesystem..."
              echo "=== Filesystem scan command ==="
              echo "trufflehog filesystem . --json --no-update --results=verified,unverified --filter-unverified (built-in detectors)"
              trufflehog filesystem . \
                --json \
                --no-update \
                --results=verified,unverified \
                --filter-unverified \
                --filter-entropy=3.0 \
                > fs-results.json || true
              echo "=== Filesystem scan results ==="
              wc -l fs-results.json || echo "No filesystem results"
              head -5 fs-results.json || echo "No filesystem content"
            fi
          fi

          # Changed files scanning (PR only)
          if [[ "${EVENT_NAME}" == "pull_request" ]]; then
            if [[ "${SCAN_SCOPE}" == "changed-files" || "${SCAN_SCOPE}" == "both" ]]; then
              if [[ -s "changed-files.txt" ]]; then
                echo "Scanning changed files..."
                echo "[]" > changed-files-results.json
                while IFS= read -r file; do
                  if [[ -f "${file}" ]]; then
                    echo "Scanning: ${file}"
                    if trufflehog filesystem "${file}" \
                        --json \
                        --no-update \
                        --results=verified,unverified \
                        --filter-unverified \
                        --filter-entropy=3.0 \
                        | jq -s 'add' changed-files-results.json - > tmp.json; then
                      mv tmp.json changed-files-results.json
                    fi
                  fi
                done < changed-files.txt
              else
                echo "No changed files to scan"
              fi
            fi
          fi

          # Merge all results - TruffleHog outputs newline-delimited JSON (NDJSON)
          echo "Merging scan results..."
          touch all-results.ndjson  # Create empty file
          for f in commit-results.json fs-results.json changed-files-results.json; do
            if [[ -s "${f}" ]]; then
              echo "Merging results from ${f}"
              cat "${f}" >> all-results.ndjson
            fi
          done

          # Convert NDJSON to JSON array for processing
          if [[ -s all-results.ndjson ]]; then
            jq -s '.' all-results.ndjson > all-results.json
          else
            echo "[]" > all-results.json
          fi

          # Count results
          VERIFIED=$(jq '[.[] | select(.Verified==true)] | length' all-results.json)
          UNVERIFIED=$(jq '[.[] | select(.Verified==false)] | length' all-results.json)
          TOTAL=$((VERIFIED+UNVERIFIED))

          echo "Scan Summary:"
          echo "Verified secrets: ${VERIFIED}"
          echo "Unverified secrets: ${UNVERIFIED}"
          echo "Total findings: ${TOTAL}"

          {
            echo "verified=${VERIFIED}"
            echo "unverified=${UNVERIFIED}"
            echo "total=${TOTAL}"
          } >> "${GITHUB_OUTPUT}"

      - name: Hide/minimize previous TruffleHog scan result comments on PR
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        id: hide-comments
        uses: int128/hide-comment-action@a30d551065e4231e6d7a671bb5ce884f9ee6417b # v1.43.0
        with:
          ends-with: "<!-- comment-action/${{ github.workflow }}/${{ github.job }} -->"

      - name: Generate formatted scan results for PR comment (verified/unverified secrets)
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        id: comment-body
        run: |
          if [[ ! -f "all-results.json" || ! -s "all-results.json" ]]; then
            echo "No results file found"
            {
              echo 'body<<EOF'
              echo '**TruffleHog Scan Results**'
              echo ''
              echo 'No secrets detected in this PR.'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Parse results
          VERIFIED=$(jq '[.[] | select(.Verified==true)] | length' all-results.json)
          UNVERIFIED=$(jq '[.[] | select(.Verified==false)] | length' all-results.json)
          TOTAL=$((VERIFIED+UNVERIFIED))

          if [[ $TOTAL -eq 0 ]]; then
            {
              echo 'body<<EOF'
              echo '**TruffleHog Scan Results**'
              echo ''
              echo 'No secrets detected in this PR.'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            # Generate findings list
            FINDINGS=$(jq -r '.[] |
              "- " +
              (if .Verified then "**VERIFIED SECRET**" else "**Possible secret**" end) +
              " (" + .DetectorName + ") at `" +
              ((.SourceMetadata?.Data?.Filesystem?.file // .SourceMetadata?.Data?.Git?.file) // "unknown") +
              ":" +
              ((.SourceMetadata?.Data?.Filesystem?.line // .SourceMetadata?.Data?.Git?.line) | tostring) +
              "` â†’ `" +
              (if (.Raw | length) > 8 then (.Raw[:4] + "***" + .Raw[-4:]) else "***" end) +
              "`"' all-results.json)

            SEVERITY=""
            if [[ $VERIFIED -gt 0 ]]; then
              SEVERITY="**CRITICAL**"
            else
              SEVERITY="**WARNING**"
            fi

            ACTION_TEXT=""
            if [[ $VERIFIED -gt 0 ]]; then
              ACTION_TEXT="**ACTION REQUIRED:** Rotate verified credentials immediately."
            else
              ACTION_TEXT="**Review:** Check if unverified secrets are false positives."
            fi

            {
              echo 'body<<EOF'
              echo "**TruffleHog Scan Results**"
              echo ''
              echo "**Summary:** Found ${TOTAL} potential secrets (${VERIFIED} verified, ${UNVERIFIED} unverified)"
              echo ''
              echo "${FINDINGS}"
              echo ''
              echo "${ACTION_TEXT}"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post TruffleHog scan results as PR comment
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: int128/comment-action@f4faf53666ef83da7d274fa2007e9212c4d719c3 # v1.39.0
        with:
          post: |
            ${{ steps.comment-body.outputs.body }}
            ${{ steps.hide-comments.outputs.ends-with }}

      - name: Create GitHub status check with scan summary (pass/fail)
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          VERIFIED_COUNT: ${{ steps.scan.outputs.verified }}
          UNVERIFIED_COUNT: ${{ steps.scan.outputs.unverified }}
          TOTAL_COUNT: ${{ steps.scan.outputs.total }}
          FAIL_ON_VERIFIED: ${{ inputs.fail-on-verified }}
          FAIL_ON_UNVERIFIED: ${{ inputs.fail-on-unverified }}
          SCAN_TYPE: ${{ inputs.scan-type }}
          SCAN_SCOPE: ${{ inputs.scan-scope }}
          TRUFFLEHOG_VERSION: ${{ inputs.trufflehog-version }}
        with:
          github-token: ${{ github.token }}
          script: |
            const verified = parseInt(process.env.VERIFIED_COUNT || "0", 10);
            const unverified = parseInt(process.env.UNVERIFIED_COUNT || "0", 10);
            const total = parseInt(process.env.TOTAL_COUNT || "0", 10);

            const shouldFail = (
              (process.env.FAIL_ON_VERIFIED === "true" && verified > 0) ||
              (process.env.FAIL_ON_UNVERIFIED === "true" && unverified > 0)
            );

            const conclusion = shouldFail ? "failure" : "success";
            const title = total > 0
              ? `Found ${total} potential secrets (${verified} verified, ${unverified} unverified)`
              : "No secrets detected";

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "TruffleHog Secret Scan",
              head_sha: context.sha,
              status: "completed",
              conclusion,
              output: {
                title,
                summary: "TruffleHog security scan completed",
                text: `Scan configuration:\n- Type: ${process.env.SCAN_TYPE}\n- Scope: ${process.env.SCAN_SCOPE}\n- Version: ${process.env.TRUFFLEHOG_VERSION || process.env.DEFAULT_VERSION}\n\nResults: ${title}`
              }
            });

      - name: Fail workflow based on secret detection policy (verified/unverified thresholds)
        env:
          VERIFIED_COUNT: ${{ steps.scan.outputs.verified }}
          UNVERIFIED_COUNT: ${{ steps.scan.outputs.unverified }}
          FAIL_ON_VERIFIED: ${{ inputs.fail-on-verified }}
          FAIL_ON_UNVERIFIED: ${{ inputs.fail-on-unverified }}
        run: |
          SHOULD_FAIL=false

          if [[ "${FAIL_ON_VERIFIED}" == "true" && "${VERIFIED_COUNT}" != "0" ]]; then
            SHOULD_FAIL=true
          fi

          if [[ "${FAIL_ON_UNVERIFIED}" == "true" && "${UNVERIFIED_COUNT}" != "0" ]]; then
            SHOULD_FAIL=true
          fi

          if [[ "${SHOULD_FAIL}" == "true" ]]; then
            echo "Workflow failed due to secrets found"
            echo "Verified secrets: ${VERIFIED_COUNT}"
            echo "Unverified secrets: ${UNVERIFIED_COUNT}"
            exit 1
          else
            echo "No action needed - secrets found but within configured thresholds"
          fi
