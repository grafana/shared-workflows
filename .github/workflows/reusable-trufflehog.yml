name: Reusable Trufflehog Scan

on:
  workflow_call:
    inputs:
      fail-on-secrets:
        description: "Fail the workflow if secrets are found"
        required: false
        default: "true"
        type: string

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trufflehog (PR)
        if: github.event_name == 'pull_request'
        run: |
          pip install trufflehog
          trufflehog git file://. --base=${{ github.event.pull_request.base.sha }} --head=${{ github.event.pull_request.head.sha }} > trufflehog-results.txt || true

      - name: Run Trufflehog (Push)
        if: github.event_name != 'pull_request'
        run: |
          pip install trufflehog
          trufflehog git file://. > trufflehog-results.txt || true

      - name: Comment on PR if secrets found
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let results = '';
            try {
              results = fs.readFileSync('trufflehog-results.txt', 'utf8');
            } catch (e) {
              results = 'No results file found.';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš¨ **Trufflehog found potential secrets in this PR!**\n\n\`\`\`\n${results}\n\`\`\``
            });

      - name: Fail if secrets found
        if: ${{ inputs.fail-on-secrets == 'true' && failure() }}
        run: exit 1