name: Reusable TruffleHog Secret Scan

on:
  workflow_call:
    inputs:
      fail-on-unverified:
        description: "Fail workflow on unverified secrets"
        required: false
        default: "false"
        type: string
      fail-on-verified:
        description: "Fail workflow on verified secrets"
        required: false
        default: "true"
        type: string
      scan-type:
        description: "Scan type: commits, filesystem, or both"
        required: false
        default: "both"
        type: string
      scan-scope:
        description: "Scan scope: changed-files, full-repo, or both"
        required: false
        default: "full-repo"
        type: string
      trufflehog-version:
        description: "TruffleHog version to use (optional override)"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  TRUFFLEHOG_VERSION: "3.75.0" # ratchet:trufflesecurity/trufflehog@v3.75.0

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          # Use env variable with fallback to input for backwards compatibility
          VERSION="${{ inputs.trufflehog-version || format('v{0}', env.TRUFFLEHOG_VERSION) }}"
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin "$VERSION"
          trufflehog --version

      - name: Create Grafana custom detectors config
        run: |
          cat > trufflehog-config.yml <<'EOF'
          detectors:
            - name: grafana-api-key
              keywords:
                - grafana
                - eyJrIjoi
              regex:
                key: 'eyJrIjoi[A-Za-z0-9+/=]{40,}'
            - name: grafana-service-account
              keywords:
                - glsa_
                - grafana
              regex:
                sa: 'glsa_[A-Za-z0-9]{32}_[A-Fa-f0-9]{8}'
            - name: grafana-cloud-token
              keywords:
                - glc_
                - grafana
              regex:
                cloud: 'glc_[A-Za-z0-9+/]{32,}={0,2}'
            - name: grafana-admin-password
              keywords:
                - GF_SECURITY_ADMIN_PASSWORD
              regex:
                admin_pass: 'GF_SECURITY_ADMIN_PASSWORD\s*[=:]\s*[^ \t\n]+'
            - name: grafana-smtp-password
              keywords:
                - GF_SMTP_PASSWORD
              regex:
                smtp_pass: 'GF_SMTP_PASSWORD\s*[=:]\s*[^ \t\n]+'
            - name: grafana-license
              keywords:
                - GF_ENTERPRISE_LICENSE_TEXT
              regex:
                license: 'GF_ENTERPRISE_LICENSE_TEXT\s*[=:]\s*[A-Za-z0-9+/=]{100,}'
          EOF

      - name: Get changed files for PR
        id: changed-files
        if: github.event_name == 'pull_request' && (inputs.scan-scope == 'changed-files' || inputs.scan-scope == 'both')
        run: |
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > changed-files.txt
          echo "Changed files in this PR:"
          cat changed-files.txt || echo "No files changed"

      - name: Run TruffleHog Scan
        id: scan
        run: |
          set +e
          
          # Initialize result files
          echo "[]" > all-results.json
          
          # Full repository scanning
          if [[ "${{ inputs.scan-scope }}" == "full-repo" || "${{ inputs.scan-scope }}" == "both" ]]; then
            echo "Running full repository scan..."
            
            if [[ "${{ inputs.scan-type }}" == "commits" || "${{ inputs.scan-type }}" == "both" ]]; then
              echo "Scanning git commit history..."
              trufflehog git file://. \
                --json \
                --no-update \
                --config=trufflehog-config.yml \
                > commit-results.json || true
            fi

            if [[ "${{ inputs.scan-type }}" == "filesystem" || "${{ inputs.scan-type }}" == "both" ]]; then
              echo "Scanning current filesystem..."
              trufflehog filesystem . \
                --json \
                --no-update \
                --config=trufflehog-config.yml \
                > fs-results.json || true
            fi
          fi

          # Changed files scanning (PR only)
          if [[ "${{ github.event_name }}" == "pull_request" && ("${{ inputs.scan-scope }}" == "changed-files" || "${{ inputs.scan-scope }}" == "both") ]]; then
            if [[ -s "changed-files.txt" ]]; then
              echo "Scanning changed files..."
              echo "[]" > changed-files-results.json
              while IFS= read -r file; do
                if [[ -f "$file" ]]; then
                  echo "Scanning: $file"
                  trufflehog filesystem "$file" \
                    --json \
                    --no-update \
                    --config=trufflehog-config.yml \
                    | jq -s 'add' changed-files-results.json - > tmp.json && mv tmp.json changed-files-results.json || true
                fi
              done < changed-files.txt
            else
              echo "No changed files to scan"
            fi
          fi

          # Merge all results
          echo "Merging scan results..."
          for f in commit-results.json fs-results.json changed-files-results.json; do
            if [[ -s "$f" ]]; then
              echo "Merging results from $f"
              jq -s 'add' all-results.json "$f" > tmp.json && mv tmp.json all-results.json
            fi
          done

          # Count results
          VERIFIED=$(jq '[.[] | select(.Verified==true)] | length' all-results.json)
          UNVERIFIED=$(jq '[.[] | select(.Verified==false)] | length' all-results.json)
          TOTAL=$((VERIFIED+UNVERIFIED))

          echo "Scan Summary:"
          echo "Verified secrets: $VERIFIED"
          echo "Unverified secrets: $UNVERIFIED"
          echo "Total findings: $TOTAL"

          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "unverified=$UNVERIFIED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            let results = [];
            try {
              const data = fs.readFileSync('all-results.json', 'utf8');
              results = JSON.parse(data);
            } catch(e) {
              console.log('No results file or parsing error:', e.message);
            }

            if (results.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "**TruffleHog Scan Results**\n\nNo secrets detected in this PR."
              });
              return;
            }

            const findings = results.map(r => {
              const file = r.SourceMetadata?.Data?.Filesystem?.file || r.SourceMetadata?.Data?.Git?.file || "unknown";
              const line = r.SourceMetadata?.Data?.Filesystem?.line || r.SourceMetadata?.Data?.Git?.line || "?";
              const detector = r.DetectorName || "unknown";
              const raw = r.Raw || "";
              const masked = raw.length > 8 ? raw.slice(0,4) + "***" + raw.slice(-4) : "***";
              const status = r.Verified ? "**VERIFIED SECRET**" : "**Possible secret**";
              return `- ${status} (${detector}) at \`${file}:${line}\` â†’ \`${masked}\``;
            }).join("\n");

            const verified = results.filter(r => r.Verified).length;
            const unverified = results.filter(r => !r.Verified).length;
            
            const severity = verified > 0 ? "**CRITICAL**" : "**WARNING**";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${severity} **TruffleHog Scan Results**\n\n**Summary:** Found ${results.length} potential secrets (${verified} verified, ${unverified} unverified)\n\n${findings}\n\n${verified > 0 ? "**ACTION REQUIRED:** Rotate verified credentials immediately." : "**Review:** Check if unverified secrets are false positives."}`
            });

      - name: Create Check Status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ github.token }}
          script: |
            const verified = parseInt("${{ steps.scan.outputs.verified }}", 10);
            const unverified = parseInt("${{ steps.scan.outputs.unverified }}", 10);
            const total = parseInt("${{ steps.scan.outputs.total }}", 10);

            const shouldFail = (
              ("${{ inputs.fail-on-verified }}" === "true" && verified > 0) ||
              ("${{ inputs.fail-on-unverified }}" === "true" && unverified > 0)
            );

            const conclusion = shouldFail ? "failure" : "success";
            const title = total > 0
              ? `Found ${total} potential secrets (${verified} verified, ${unverified} unverified)`
              : "No secrets detected";

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "TruffleHog Secret Scan",
              head_sha: context.sha,
              status: "completed",
              conclusion,
              output: {
                title,
                summary: "TruffleHog security scan completed",
                text: `Scan configuration:\n- Type: ${{ inputs.scan-type }}\n- Scope: ${{ inputs.scan-scope }}\n- Version: ${{ inputs.trufflehog-version }}\n\nResults: ${title}`
              }
            });

      - name: Fail workflow if secrets found
        if: |
          (steps.scan.outputs.verified != '0' && inputs.fail-on-verified == 'true') ||
          (steps.scan.outputs.unverified != '0' && inputs.fail-on-unverified == 'true')
        run: |
          echo "Workflow failed due to secrets found"
          echo "Verified secrets: ${{ steps.scan.outputs.verified }}"
          echo "Unverified secrets: ${{ steps.scan.outputs.unverified }}"
          exit 1