name: Reusable Trufflehog Secret Scan

on:
  workflow_call:

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Trufflehog
        run: pip install trufflehog

      - name: Run Trufflehog
        run: |
          trufflehog filesystem . --json --no-update > trufflehog-results.json || true

      - name: Debug Trufflehog output
        run: cat trufflehog-results.json || echo "No trufflehog-results.json found"

      - name: Comment on PR with all Trufflehog findings (full JSON, clean format)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let findings = [];
            try {
              const lines = fs.readFileSync('trufflehog-results.json', 'utf8')
                .split('\n')
                .filter(Boolean);
              for (const line of lines) {
                let finding;
                try {
                  finding = JSON.parse(line);
                } catch (e) {
                  continue;
                }
                if (finding.Raw) {
                  findings.push(
                    [
                      '---',
                      '**Trufflehog Finding:**',
                      '',
                      '```json',
                      JSON.stringify(finding, null, 2),
                      '```',
                      ''
                    ].join('\n')
                  );
                }
              }
            } catch (e) {
              findings = ['(Could not parse Trufflehog report)'];
            }
            const body = findings.length
              ? `ðŸš¨ **Trufflehog found secrets in this PR!**\n\n${findings.join('\n')}`
              : "âœ… Trufflehog ran and no secrets were found.";
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail if any secrets found
        if: ${{ hashFiles('trufflehog-results.json') != '' }}
        run: |
          if grep -q '"Raw":' trufflehog-results.json; then
            echo "Secrets found! Failing the workflow."
            exit 1
          fi

  security-secrets:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    env:
      SCAN_PATH: "." # Set the relative path in the repo to scan
    steps:
      - name: Install dependencies
        run: apk add --no-cache git curl jq

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trufflehog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Trufflehog scan (GitLab style)
        run: |
          trufflehog filesystem "$SCAN_PATH" --results=verified,unknown --fail --json > trufflehog-results.json || true
          cat trufflehog-results.json | jq

      - name: Fail if any secrets found
        run: |
          if grep -q '"Raw":' trufflehog-results.json; then
            echo "Secrets found! Failing the workflow."
            exit 1
          fi